<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CustomEraService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">voting-ledger-follower-app</a> &gt; <a href="index.source.html" class="el_package">org.cardano.foundation.voting.service.epoch</a> &gt; <span class="el_source">CustomEraService.java</span></div><h1>CustomEraService.java</h1><pre class="source lang-java linenums">package org.cardano.foundation.voting.service.epoch;

import com.bloxbean.cardano.yaci.core.model.Era;
import com.bloxbean.cardano.yaci.store.core.configuration.GenesisConfig;
import com.bloxbean.cardano.yaci.store.core.service.EraService;
import org.cardano.foundation.voting.domain.CardanoNetwork;
import org.cardano.foundation.voting.domain.EraData;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.Arrays;
import java.util.Optional;

@Service
<span class="fc" id="L15">public class CustomEraService {</span>

    @Autowired
    private GenesisConfig genesisConfig;

    @Autowired
    private EraService eraService;

    public Optional&lt;EraData&gt; getEraData(Era era, CardanoNetwork cardanoNetwork) {
<span class="fc" id="L24">        return getStartAbsoluteSlot(era, cardanoNetwork)</span>
<span class="fc" id="L25">                .flatMap(startAbsoluteSlot -&gt; getEndAbsoluteSlot(era, cardanoNetwork)</span>
<span class="fc" id="L26">                    .flatMap(endAbsoluteSlot -&gt; getStartBlock(era, cardanoNetwork)</span>
<span class="fc" id="L27">                    .flatMap(startBlock -&gt; getEndBlock(era, cardanoNetwork)</span>
<span class="fc" id="L28">                        .flatMap(endBlock -&gt; getStartEpochTime(era, cardanoNetwork)</span>
<span class="fc" id="L29">                                .flatMap(startEpochTime -&gt; getEndEpochTime(era, cardanoNetwork)</span>
<span class="fc" id="L30">                                        .flatMap(endEpochTime -&gt; getStartEpochNumber(era, cardanoNetwork)</span>
<span class="fc" id="L31">                                                .flatMap(startEpochNumber -&gt; getEndEpochNumber(era, cardanoNetwork)</span>
<span class="fc" id="L32">                                                        .map(endEpochNumber -&gt; new EraData(</span>
<span class="fc" id="L33">                                                                startAbsoluteSlot,</span>
<span class="fc" id="L34">                                                                endAbsoluteSlot,</span>
<span class="fc" id="L35">                                                                startBlock,</span>
<span class="fc" id="L36">                                                                endBlock,</span>
<span class="fc" id="L37">                                                                startEpochTime,</span>
<span class="fc" id="L38">                                                                endEpochTime,</span>
<span class="fc" id="L39">                                                                startEpochNumber,</span>
<span class="fc" id="L40">                                                                endEpochNumber,</span>
<span class="fc" id="L41">                                                                previousEra(era),</span>
<span class="fc" id="L42">                                                                nextEra(era)</span>
                                                        ))
                                                )
                                        ))))));
    }

    public Optional&lt;Long&gt; getEndEpochTime(Era era, CardanoNetwork cardanoNetwork) {
<span class="fc" id="L49">        return getEndAbsoluteSlot(era, cardanoNetwork).map(absoluteSlot -&gt; eraService.blockTime(era, absoluteSlot));</span>
    }

    public Optional&lt;Long&gt; getStartEpochTime(Era era, CardanoNetwork cardanoNetwork) {
<span class="fc" id="L53">        return getStartAbsoluteSlot(era, cardanoNetwork).map(absoluteSlot -&gt; eraService.blockTime(era, absoluteSlot));</span>
    }

    public Optional&lt;Integer&gt; getEndEpochNumber(Era era, CardanoNetwork network) {
<span class="pc bpc" id="L57" title="2 of 3 branches missed.">        return switch (network) {</span>
<span class="pc bpc" id="L58" title="2 of 3 branches missed.">            case MAIN, PREPROD -&gt; switch (era)  {</span>
<span class="fc" id="L59">                case Byron, Shelley, Allegra, Mary, Alonzo -&gt; getEndAbsoluteSlot(era, network)</span>
<span class="fc" id="L60">                        .map(slot -&gt; (int) (slot / genesisConfig.slotsPerEpoch(era)));</span>
<span class="nc" id="L61">                case Babbage -&gt; Optional.empty();</span>
            };
<span class="nc" id="L63">            case PREVIEW, DEV -&gt; Optional.empty();</span>
        };
    }

    // TODO
    public Optional&lt;Integer&gt; getStartEpochNumber(Era era, CardanoNetwork network) {
<span class="fc" id="L69">        return Optional.of(-1);</span>
    }

    public Optional&lt;Integer&gt; getEndBlock(Era era, CardanoNetwork network) {
<span class="pc bpc" id="L73" title="3 of 4 branches missed.">        return switch (network) {</span>
<span class="nc bnc" id="L74" title="All 7 branches missed.">            case MAIN -&gt; switch (era)  {</span>
<span class="nc" id="L75">                case Byron -&gt; Optional.of(4490510);</span>
<span class="nc" id="L76">                case Shelley -&gt; Optional.of(5086523);</span>
<span class="nc" id="L77">                case Allegra -&gt; Optional.of(5406746);</span>
<span class="nc" id="L78">                case Mary -&gt; Optional.of(6236059);</span>
<span class="nc" id="L79">                case Alonzo -&gt; Optional.of(7791698);</span>
<span class="nc" id="L80">                case Babbage -&gt; Optional.empty();</span>
            };
<span class="pc bpc" id="L82" title="6 of 7 branches missed.">            case PREPROD -&gt; switch (era)  {</span>
<span class="fc" id="L83">                case Byron -&gt; Optional.of(45);</span>
<span class="nc" id="L84">                case Shelley -&gt; Optional.of(21644);</span>
<span class="nc" id="L85">                case Allegra -&gt; Optional.of(43242);</span>
<span class="nc" id="L86">                case Mary -&gt; Optional.of(64902);</span>
<span class="nc" id="L87">                case Alonzo -&gt; Optional.of(172497);</span>
<span class="nc" id="L88">                case Babbage -&gt; Optional.empty();</span>
            };
<span class="nc" id="L90">            case PREVIEW, DEV -&gt; Optional.empty();</span>
        };
    }

    public Optional&lt;Long&gt; getEndAbsoluteSlot(Era era, CardanoNetwork network) {
<span class="pc bpc" id="L95" title="3 of 4 branches missed.">        return switch (network) {</span>
<span class="nc bnc" id="L96" title="All 7 branches missed.">            case MAIN -&gt; switch (era)  {</span>
<span class="nc" id="L97">                case Byron -&gt; Optional.of(4492799L);</span>
<span class="nc" id="L98">                case Shelley -&gt; Optional.of(16588737L);</span>
<span class="nc" id="L99">                case Allegra -&gt; Optional.of(23068793L);</span>
<span class="nc" id="L100">                case Mary -&gt; Optional.of(39916796L);</span>
<span class="nc" id="L101">                case Alonzo -&gt; Optional.of(72316796L);</span>
<span class="nc" id="L102">                case Babbage -&gt; Optional.empty();</span>
            };
<span class="pc bpc" id="L104" title="6 of 7 branches missed.">            case PREPROD -&gt; switch (era)  {</span>
<span class="fc" id="L105">                case Byron -&gt; Optional.of(84242L);</span>
<span class="nc" id="L106">                case Shelley -&gt; Optional.of(518360L);</span>
<span class="nc" id="L107">                case Allegra -&gt; Optional.of(950340L);</span>
<span class="nc" id="L108">                case Mary -&gt; Optional.of(1382348L);</span>
<span class="nc" id="L109">                case Alonzo -&gt; Optional.of(3542390L);</span>
<span class="nc" id="L110">                case Babbage -&gt; Optional.empty();</span>
            };
<span class="nc" id="L112">            case PREVIEW, DEV -&gt; Optional.empty();</span>
        };
    }

    public Optional&lt;Integer&gt; getStartBlock(Era era, CardanoNetwork network) {
<span class="pc bpc" id="L117" title="2 of 3 branches missed.">        return switch (network) {</span>
<span class="pc bpc" id="L118" title="2 of 3 branches missed.">            case MAIN, PREPROD -&gt; switch (era)  {</span>
<span class="fc" id="L119">                case Byron -&gt; Optional.of(0);</span>
                case Shelley, Allegra, Mary, Alonzo, Babbage -&gt; {
<span class="nc" id="L121">                    Era previousEra = previousEra(era).orElseThrow();</span>

<span class="nc" id="L123">                    yield getEndBlock(previousEra, network)</span>
<span class="nc" id="L124">                            .map(lastBlock -&gt; lastBlock + 1);</span>
                }
            };
<span class="nc" id="L127">            case PREVIEW, DEV -&gt; Optional.empty();</span>
        };
    }

    public Optional&lt;Long&gt; getStartAbsoluteSlot(Era era, CardanoNetwork network) {
<span class="pc bpc" id="L132" title="2 of 3 branches missed.">        return switch (network) {</span>
<span class="pc bpc" id="L133" title="2 of 3 branches missed.">            case MAIN, PREPROD -&gt; switch (era)  {</span>
<span class="fc" id="L134">                case Byron -&gt; Optional.of(0L);</span>
                case Shelley, Allegra, Mary, Alonzo, Babbage -&gt; {
<span class="nc" id="L136">                    Era previousEra = previousEra(era).orElseThrow();</span>

<span class="nc" id="L138">                    yield getEndAbsoluteSlot(previousEra, network)</span>
<span class="nc" id="L139">                            .map(lastBlock -&gt; lastBlock + 1);</span>
                }
            };
<span class="nc" id="L142">            case PREVIEW, DEV -&gt; Optional.empty();</span>
        };
    }

    public Optional&lt;Era&gt; previousEra(Era era) {
<span class="pc bpc" id="L147" title="2 of 3 branches missed.">        return switch (era) {</span>
<span class="fc" id="L148">            case Byron -&gt; Optional.empty();</span>
<span class="nc" id="L149">            case Shelley, Allegra, Mary, Alonzo, Babbage -&gt; Arrays.stream(Era.values())</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">                    .filter(e -&gt; e.value == era.value - 1)</span>
<span class="nc" id="L151">                    .findFirst();</span>
        };
    }

    public Optional&lt;Era&gt; nextEra(Era era) {
<span class="pc bpc" id="L156" title="2 of 3 branches missed.">        return switch (era) {</span>
<span class="fc" id="L157">            case Byron -&gt; Optional.empty();</span>
<span class="nc" id="L158">            case Shelley, Allegra, Mary, Alonzo, Babbage -&gt; Arrays.stream(Era.values())</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">                    .filter(e -&gt; e.value == era.value + 1)</span>
<span class="nc" id="L160">                    .findFirst();</span>
        };
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>