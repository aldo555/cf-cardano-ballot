<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Web3Filter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">voting-app</a> &gt; <a href="index.source.html" class="el_package">org.cardano.foundation.voting.service.auth.web3</a> &gt; <span class="el_source">Web3Filter.java</span></div><h1>Web3Filter.java</h1><pre class="source lang-java linenums">package org.cardano.foundation.voting.service.auth.web3;

import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.cardano.foundation.voting.client.ChainFollowerClient;
import org.cardano.foundation.voting.domain.CardanoNetwork;
import org.cardano.foundation.voting.domain.web3.SignedWeb3Request;
import org.cardano.foundation.voting.service.auth.LoginSystemDetector;
import org.cardano.foundation.voting.service.expire.ExpirationService;
import org.cardano.foundation.voting.service.json.JsonService;
import org.cardano.foundation.voting.utils.Enums;
import org.cardano.foundation.voting.utils.StakeAddress;
import org.cardanofoundation.cip30.AddressFormat;
import org.cardanofoundation.cip30.CIP30Verifier;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;
import org.zalando.problem.Problem;

import java.io.IOException;
import java.util.List;
import java.util.Optional;

import static org.cardano.foundation.voting.domain.Role.VOTER;
import static org.cardano.foundation.voting.resource.Headers.XCIP93PublicKey;
import static org.cardano.foundation.voting.resource.Headers.XCIP93Signature;
import static org.cardano.foundation.voting.service.auth.LoginSystem.CIP93;
import static org.cardano.foundation.voting.utils.MoreNumber.isNumeric;
import static org.cardanofoundation.cip30.MessageFormat.TEXT;
import static org.zalando.problem.Status.*;

@Component
<span class="fc" id="L39">@RequiredArgsConstructor</span>
<span class="fc" id="L40">@Slf4j</span>
public class Web3Filter extends OncePerRequestFilter {

    private final JsonService jsonService;

    private final ExpirationService expirationService;

    private final ObjectMapper objectMapper;

    // TODO can we do this via local access?
    private final ChainFollowerClient chainFollowerClient;

    private final CardanoNetwork cardanoNetwork;

    private final LoginSystemDetector loginSystemDetector;


    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain chain) throws ServletException, IOException {
<span class="fc" id="L61">        var maybeLoginSystem = loginSystemDetector.detect(request);</span>

<span class="fc bfc" id="L63" title="All 2 branches covered.">        if (maybeLoginSystem.isEmpty()) {</span>
<span class="fc" id="L64">            chain.doFilter(request, response);</span>
<span class="fc" id="L65">            return;</span>
        }
<span class="fc" id="L67">        var loginSystem = maybeLoginSystem.orElseThrow();</span>

<span class="fc bfc" id="L69" title="All 2 branches covered.">        if (loginSystem != CIP93) {</span>
<span class="fc" id="L70">            chain.doFilter(request, response);</span>
<span class="fc" id="L71">            return;</span>
        }

<span class="fc" id="L74">        var coseSignature = request.getHeader(XCIP93Signature);</span>
<span class="fc" id="L75">        var cosePublicKey = request.getHeader(XCIP93PublicKey);</span>

<span class="pc bpc" id="L77" title="1 of 2 branches missed.">        if (coseSignature == null) {</span>
<span class="nc" id="L78">            var problem = Problem.builder()</span>
<span class="nc" id="L79">                    .withTitle(&quot;NO_CIP93_HTTP_HEADERS_SET&quot;)</span>
<span class="nc" id="L80">                    .withDetail(&quot;CIP-93 http headers must be set.&quot;)</span>
<span class="nc" id="L81">                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L82">                    .build();</span>

<span class="nc" id="L84">            sendBackProblem(response, problem);</span>
<span class="nc" id="L85">            return;</span>
        }

<span class="fc" id="L88">        var signedWeb3Request = new SignedWeb3Request(coseSignature, Optional.ofNullable(cosePublicKey));</span>

<span class="fc" id="L90">        var cip30Verifier = new CIP30Verifier(signedWeb3Request.getCoseSignature(), signedWeb3Request.getCosePublicKey());</span>
<span class="fc" id="L91">        var cipVerificationResult = cip30Verifier.verify();</span>

<span class="pc bpc" id="L93" title="1 of 2 branches missed.">        if (!cipVerificationResult.isValid()) {</span>
<span class="nc" id="L94">            log.info(&quot;Unable to decode valid signed web3 request!&quot;);</span>

<span class="nc" id="L96">            var problem = Problem.builder()</span>
<span class="nc" id="L97">                    .withTitle(&quot;INVALID_CIP30_DATA_SIGNATURE&quot;)</span>
<span class="nc" id="L98">                    .withDetail(&quot;Invalid CIP93 cose signature!&quot;)</span>
<span class="nc" id="L99">                    .withStatus(UNAUTHORIZED)</span>
<span class="nc" id="L100">                    .build();</span>

<span class="nc" id="L102">            sendBackProblem(response, problem);</span>
<span class="nc" id="L103">            return;</span>
        }

<span class="fc" id="L106">        var maybeAddress = cipVerificationResult.getAddress(AddressFormat.TEXT);</span>
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">        if (maybeAddress.isEmpty()) {</span>
<span class="nc" id="L108">            var problem = Problem.builder()</span>
<span class="nc" id="L109">                    .withTitle(&quot;ADDRESS_NOT_FOUND&quot;)</span>
<span class="nc" id="L110">                    .withDetail(&quot;Bech32 address not found in the signed data.&quot;)</span>
<span class="nc" id="L111">                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L112">                    .build();</span>

<span class="nc" id="L114">            sendBackProblem(response, problem);</span>
<span class="nc" id="L115">            return;</span>
        }
<span class="fc" id="L117">        var stakeAddress = maybeAddress.orElseThrow();</span>

<span class="fc" id="L119">        var cipBody = cipVerificationResult.getMessage(TEXT);</span>

<span class="fc" id="L121">        var cip93EnvelopeE = jsonService.decodeGenericCIP93(cipBody);</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">        if (cip93EnvelopeE.isEmpty()) {</span>
<span class="nc" id="L123">            log.info(&quot;Invalid CIP-93 envelope!&quot;);</span>

<span class="nc" id="L125">            var problem = Problem.builder()</span>
<span class="nc" id="L126">                    .withTitle(&quot;INVALID_CIP93_ENVELOPE&quot;)</span>
<span class="nc" id="L127">                    .withDetail(&quot;CIP-93 envelope decoding failed.&quot;)</span>
<span class="nc" id="L128">                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L129">                    .build();</span>

<span class="nc" id="L131">            sendBackProblem(response, problem);</span>

<span class="nc" id="L133">            return;</span>
        }

<span class="fc" id="L136">        var genericEnvelope = cip93EnvelopeE.get();</span>

<span class="fc" id="L138">        var maybeWeb3Action = genericEnvelope.getActionAsEnum();</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">        if (maybeWeb3Action.isEmpty()) {</span>
<span class="nc" id="L140">            log.info(&quot;Unrecognised action, action:{}&quot;, genericEnvelope.getAction());</span>

<span class="nc" id="L142">            var problem = Problem.builder()</span>
<span class="nc" id="L143">                    .withTitle(&quot;ACTION_NOT_FOUND&quot;)</span>
<span class="nc" id="L144">                    .withDetail(&quot;Action not found!&quot;)</span>
<span class="nc" id="L145">                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L146">                    .build();</span>

<span class="nc" id="L148">            sendBackProblem(response, problem);</span>
<span class="nc" id="L149">            return;</span>
        }

<span class="fc" id="L152">        var web3Action = maybeWeb3Action.orElseThrow();</span>

<span class="fc" id="L154">        String slotStr = genericEnvelope.getSlot();</span>
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">        if (!isNumeric(slotStr)) {</span>
<span class="nc" id="L156">            var problem = Problem.builder()</span>
<span class="nc" id="L157">                            .withTitle(&quot;INVALID_SLOT&quot;)</span>
<span class="nc" id="L158">                            .withDetail(&quot;CIP-93 envelope slot is not numeric!&quot;)</span>
<span class="nc" id="L159">                            .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L160">                            .build();</span>

<span class="nc" id="L162">            sendBackProblem(response, problem);</span>
<span class="nc" id="L163">            return;</span>
        }

<span class="fc" id="L166">        var chainTipE = chainFollowerClient.getChainTip();</span>
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">        if (chainTipE.isEmpty()) {</span>
<span class="nc" id="L168">            var problem = Problem.builder()</span>
<span class="nc" id="L169">                    .withTitle(&quot;CHAIN_TIP_ERROR&quot;)</span>
<span class="nc" id="L170">                    .withDetail(&quot;Unable to get chain tip from chain-tip follower service, reason: &quot; + chainTipE.swap().get().getDetail())</span>
<span class="nc" id="L171">                    .withStatus(INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L172">                    .build();</span>

<span class="nc" id="L174">            sendBackProblem(response, problem);</span>
<span class="nc" id="L175">            return;</span>
        }
<span class="fc" id="L177">        var chainTip = chainTipE.get();</span>

<span class="fc" id="L179">        var slot = genericEnvelope.getSlotAsLong();</span>
<span class="fc" id="L180">        var slotExpired = expirationService.isSlotExpired(chainTip, slot);</span>

<span class="fc bfc" id="L182" title="All 2 branches covered.">        if (slotExpired) {</span>
<span class="fc" id="L183">            var problem = Problem.builder()</span>
<span class="fc" id="L184">                    .withTitle(&quot;EXPIRED_SLOT&quot;)</span>
<span class="fc" id="L185">                    .withDetail(&quot;CIP-93 envelope slot expired!&quot;)</span>
<span class="fc" id="L186">                    .withStatus(BAD_REQUEST)</span>
<span class="fc" id="L187">                    .build();</span>

<span class="fc" id="L189">            sendBackProblem(response, problem);</span>
<span class="fc" id="L190">            return;</span>
        }

<span class="fc" id="L193">        var eventId = (String) genericEnvelope.getData().get(&quot;event&quot;);</span>
<span class="fc" id="L194">        var networkString = (String) genericEnvelope.getData().get(&quot;network&quot;);</span>
<span class="fc" id="L195">        var envelopeStakeAddress = genericEnvelope.getData().get(&quot;address&quot;);</span>

<span class="fc" id="L197">        var maybeNetwork = Enums.getIfPresent(CardanoNetwork.class, networkString);</span>
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">        if (maybeNetwork.isEmpty()) {</span>
<span class="nc" id="L199">            var problem = Problem.builder()</span>
<span class="nc" id="L200">                    .withTitle(&quot;INVALID_NETWORK&quot;)</span>
<span class="nc" id="L201">                    .withDetail(&quot;Invalid network, supported networks:&quot; + CardanoNetwork.supportedNetworks())</span>
<span class="nc" id="L202">                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L203">                    .build();</span>

<span class="nc" id="L205">            sendBackProblem(response, problem);</span>
<span class="nc" id="L206">            return;</span>
        }
<span class="fc" id="L208">        var network = maybeNetwork.get();</span>

<span class="pc bpc" id="L210" title="1 of 2 branches missed.">        if (network != cardanoNetwork) {</span>
<span class="nc" id="L211">            log.warn(&quot;Invalid network, network:{}&quot;, networkString);</span>

<span class="nc" id="L213">            var problem = Problem.builder()</span>
<span class="nc" id="L214">                    .withTitle(&quot;NETWORK_MISMATCH&quot;)</span>
<span class="nc" id="L215">                    .withDetail(&quot;Invalid network, backed configured with network:&quot; + cardanoNetwork + &quot;, however request is with network:&quot; + network)</span>
<span class="nc" id="L216">                    .withStatus(BAD_REQUEST)</span>
<span class="nc" id="L217">                    .build();</span>

<span class="nc" id="L219">            sendBackProblem(response, problem);</span>
<span class="nc" id="L220">            return;</span>
        }

<span class="fc" id="L223">        var stakeAddressCheckE = StakeAddress.checkStakeAddress(network, stakeAddress);</span>
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">        if (stakeAddressCheckE.isEmpty()) {</span>
<span class="nc" id="L225">            var problem = stakeAddressCheckE.getLeft();</span>

<span class="nc" id="L227">            sendBackProblem(response, problem);</span>
<span class="nc" id="L228">            return;</span>
        }

<span class="fc bfc" id="L231" title="All 2 branches covered.">        if (!stakeAddress.equals(envelopeStakeAddress)) {</span>
<span class="fc" id="L232">            var problem = Problem.builder()</span>
<span class="fc" id="L233">                    .withTitle(&quot;STAKE_ADDRESS_MISMATCH&quot;)</span>
<span class="fc" id="L234">                    .withDetail(&quot;Stake address mismatch, CIP-93 signed address:&quot; + stakeAddress + &quot;, however request is with address:&quot; + envelopeStakeAddress)</span>
<span class="fc" id="L235">                    .withStatus(BAD_REQUEST)</span>
<span class="fc" id="L236">                    .build();</span>

<span class="fc" id="L238">            sendBackProblem(response, problem);</span>
<span class="fc" id="L239">            return;</span>
        }

<span class="fc" id="L242">        var eventDetailsE = chainFollowerClient.getEventDetails(eventId);</span>
<span class="pc bpc" id="L243" title="1 of 2 branches missed.">        if (eventDetailsE.isEmpty()) {</span>
<span class="nc" id="L244">            var problem = Problem.builder()</span>
<span class="nc" id="L245">                    .withTitle(&quot;ERROR_GETTING_EVENT_DETAILS&quot;)</span>
<span class="nc" id="L246">                    .withDetail(&quot;Unable to get event details from chain-tip follower service, event:&quot; + eventId)</span>
<span class="nc" id="L247">                    .withStatus(INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L248">                    .build();</span>

<span class="nc" id="L250">            sendBackProblem(response, problem);</span>
<span class="nc" id="L251">            return;</span>
        }

<span class="fc" id="L254">        var maybeEventDetails = eventDetailsE.get();</span>
<span class="fc bfc" id="L255" title="All 2 branches covered.">        if (maybeEventDetails.isEmpty()) {</span>
<span class="fc" id="L256">            var problem = Problem.builder()</span>
<span class="fc" id="L257">                    .withTitle(&quot;UNRECOGNISED_EVENT&quot;)</span>
<span class="fc" id="L258">                    .withDetail(&quot;Event not found, id: &quot; + eventId)</span>
<span class="fc" id="L259">                    .withStatus(BAD_REQUEST)</span>
<span class="fc" id="L260">                    .build();</span>

<span class="fc" id="L262">            sendBackProblem(response, problem);</span>
<span class="fc" id="L263">            return;</span>
        }

<span class="fc" id="L266">        var eventDetails = maybeEventDetails.orElseThrow();</span>

<span class="fc" id="L268">        var web3Details = Web3Details.builder()</span>
<span class="fc" id="L269">                .event(eventDetails)</span>
<span class="fc" id="L270">                .stakeAddress(stakeAddress)</span>
<span class="fc" id="L271">                .signedWeb3Request(signedWeb3Request)</span>
<span class="fc" id="L272">                .chainTip(chainTip)</span>
<span class="fc" id="L273">                .action(web3Action)</span>
<span class="fc" id="L274">                .envelope(genericEnvelope)</span>
<span class="fc" id="L275">                .cip30VerificationResult(cipVerificationResult)</span>
<span class="fc" id="L276">                .network(network)</span>
<span class="fc" id="L277">                .build();</span>

<span class="fc" id="L279">        var authentication = new Web3AuthenticationToken(web3Details, List.of(new SimpleGrantedAuthority(VOTER.name())));</span>

<span class="fc" id="L281">        SecurityContextHolder.getContext().setAuthentication(authentication);</span>

<span class="fc" id="L283">        chain.doFilter(request, response);</span>
<span class="fc" id="L284">    }</span>

    private void sendBackProblem(HttpServletResponse response, Problem problem) throws IOException {
<span class="fc" id="L287">        var statusCode = problem.getStatus().getStatusCode();</span>

<span class="fc" id="L289">        response.setStatus(statusCode);</span>
<span class="fc" id="L290">        response.setContentType(&quot;application/json&quot;);</span>
<span class="fc" id="L291">        response.setCharacterEncoding(&quot;UTF-8&quot;);</span>
<span class="fc" id="L292">        response.getOutputStream().println(objectMapper.writeValueAsString(problem));</span>
<span class="fc" id="L293">        response.getOutputStream().flush();</span>
<span class="fc" id="L294">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>